esphome:
  name: proxmox-panel

esp32:
  board: esp32-s3-devkitc-1
  variant: esp32s3
  framework:
    type: esp-idf

psram:
  mode: octal
  speed: 80MHz

logger:
api:
  encryption:
    key: !secret api_encryption_key

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  use_address: 192.168.1.185

# --- JC3248W535C_I hardware (QSPI + AXS15231) ---
spi:
  - type: quad
    clk_pin: 47
    data_pins: [21, 48, 40, 39]

i2c:
  - id: i2c_bus
    sda: 4
    scl: 8

output:
  - platform: ledc
    id: gpio_backlight_pwm
    pin: 1

light:
  - platform: monochromatic
    id: backlight
    name: Backlight
    output: gpio_backlight_pwm
    restore_mode: ALWAYS_ON

display:
  - platform: qspi_dbi
    id: lcd
    dimensions:
      width: 320
      height: 480
    rotation: 90
    model: CUSTOM
    data_rate: 40MHz
    cs_pin:
      number: 45
      ignore_strapping_warning: true
    draw_from_origin: true
    update_interval: never
    auto_clear_enabled: false

touchscreen:
  - platform: axs15231
    id: touch
    i2c_id: i2c_bus
    address: 0x3B
    transform:
      swap_xy: true
      mirror_x: true
    on_touch:
      - lambda: |-
          if (!id(touch_down)) {
            id(touch_down) = true;
            id(touch_start_x) = touch.x;
            id(touch_start_y) = touch.y;
            id(swipe_consumed) = false;
            ESP_LOGI("swipe", "touch start x=%d y=%d", touch.x, touch.y);
          }
    on_update:
      - lambda: |-
          for (auto t : touches) {
            if (t.state == 1 && !id(touch_down)) {
              id(touch_down) = true;
              id(touch_start_x) = t.x;
              id(touch_start_y) = t.y;
              id(swipe_consumed) = false;
              ESP_LOGI("swipe", "update start x=%d y=%d id=%d", t.x, t.y, t.id);
            }
            if ((t.state == 1 || t.state == 2) && !id(swipe_consumed)) {
              int dx = (int) t.x - id(touch_start_x);
              uint32_t now = millis();
              if ((dx > 70 || dx < -70) && (now - id(last_swipe_ms) > 500)) {
                /* Invert so left swipe => next and right swipe => previous with current transform. */
                id(swipe_direction) = (dx < 0) ? -1 : 1;
                id(swipe_consumed) = true;
                id(last_swipe_ms) = now;
                ESP_LOGI("swipe", "gesture detected dx=%d dir=%d now=%u", dx, id(swipe_direction), now);
              }
            }
          }
      - if:
          condition:
            lambda: 'return id(swipe_direction) == 1;'
          then:
            - script.execute: go_next_page
            - lambda: 'id(swipe_direction) = 0;'
      - if:
          condition:
            lambda: 'return id(swipe_direction) == -1;'
          then:
            - script.execute: go_prev_page
            - lambda: 'id(swipe_direction) = 0;'
    on_release:
      - lambda: |-
          ESP_LOGI("swipe", "touch release, reset swipe state");
          id(touch_down) = false;
          id(swipe_consumed) = false;
          id(swipe_direction) = 0;
    update_interval: 50ms
    touch_timeout: 50ms

# Fonts
font:
  - file: "gfonts://Roboto"
    id: f_title
    size: 34
  - file: "gfonts://Roboto Mono"
    id: f_row
    size: 20
  - file: "gfonts://Roboto Mono"
    id: f_small
    size: 18

image:
  - file: "proxmox-panelbg.png"
    id: proxmox_logo
    resize: 108x32
    type: RGB565

globals:
  - id: touch_start_x
    type: int
    restore_value: no
    initial_value: '0'
  - id: touch_start_y
    type: int
    restore_value: no
    initial_value: '0'
  - id: touch_down
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: swipe_consumed
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: swipe_direction
    type: int
    restore_value: no
    initial_value: '0'
  - id: last_swipe_ms
    type: uint32_t
    restore_value: no
    initial_value: '0'

script:
  - id: go_next_page
    then:
      - if:
          condition:
            lvgl.page.is_showing: main_page
          then:
            - logger.log: "Swipe next: main -> node1"
            - lvgl.page.show: node1_page
          else:
            - if:
                condition:
                  lvgl.page.is_showing: node1_page
                then:
                  - logger.log: "Swipe next: node1 -> node2"
                  - lvgl.page.show: node2_page
                else:
                  - if:
                      condition:
                        lvgl.page.is_showing: node2_page
                      then:
                        - logger.log: "Swipe next: node2 -> node3"
                        - lvgl.page.show: node3_page
                      else:
                        - if:
                            condition:
                              lvgl.page.is_showing: node3_page
                            then:
                              - logger.log: "Swipe next: node3 -> node4"
                              - lvgl.page.show: node4_page
                            else:
                              - if:
                                  condition:
                                    lvgl.page.is_showing: node4_page
                                  then:
                                    - logger.log: "Swipe next: node4 -> node5"
                                    - lvgl.page.show: node5_page
                                  else:
                                    - if:
                                        condition:
                                          lvgl.page.is_showing: node5_page
                                        then:
                                          - logger.log: "Swipe next: node5 -> main"
                                          - lvgl.page.show: main_page
      - lambda: |-
          id(swipe_direction) = 0;
          id(swipe_consumed) = true;
          id(touch_down) = false;
  - id: go_prev_page
    then:
      - if:
          condition:
            lvgl.page.is_showing: main_page
          then:
            - logger.log: "Swipe prev: main -> node5"
            - lvgl.page.show: node5_page
          else:
            - if:
                condition:
                  lvgl.page.is_showing: node1_page
                then:
                  - logger.log: "Swipe prev: node1 -> main"
                  - lvgl.page.show: main_page
                else:
                  - if:
                      condition:
                        lvgl.page.is_showing: node2_page
                      then:
                        - logger.log: "Swipe prev: node2 -> node1"
                        - lvgl.page.show: node1_page
                      else:
                        - if:
                            condition:
                              lvgl.page.is_showing: node3_page
                            then:
                              - logger.log: "Swipe prev: node3 -> node2"
                              - lvgl.page.show: node2_page
                            else:
                              - if:
                                  condition:
                                    lvgl.page.is_showing: node4_page
                                  then:
                                    - logger.log: "Swipe prev: node4 -> node3"
                                    - lvgl.page.show: node3_page
                                  else:
                                    - if:
                                        condition:
                                          lvgl.page.is_showing: node5_page
                                        then:
                                          - logger.log: "Swipe prev: node5 -> node4"
                                          - lvgl.page.show: node4_page
      - lambda: |-
          id(swipe_direction) = 0;
          id(swipe_consumed) = true;
          id(touch_down) = false;

# --- Home Assistant entities (from your dump) ---
binary_sensor:
  - platform: homeassistant
    id: n1_up
    entity_id: binary_sensor.node_proxmox_1_status
  - platform: homeassistant
    id: n2_up
    entity_id: binary_sensor.node_proxmox_2_status
  - platform: homeassistant
    id: n3_up
    entity_id: binary_sensor.node_proxmox_3_status
  - platform: homeassistant
    id: n4_up
    entity_id: binary_sensor.node_proxmox_4_status
  - platform: homeassistant
    id: n5_up
    entity_id: binary_sensor.node_proxmox_5_status

  - platform: homeassistant
    id: n1_updates_pending
    entity_id: binary_sensor.node_proxmox_1_updates_packages
  - platform: homeassistant
    id: n2_updates_pending
    entity_id: binary_sensor.node_proxmox_2_updates_packages
  - platform: homeassistant
    id: n3_updates_pending
    entity_id: binary_sensor.node_proxmox_3_updates_packages
  - platform: homeassistant
    id: n4_updates_pending
    entity_id: binary_sensor.node_proxmox_4_updates_packages
  - platform: homeassistant
    id: n5_updates_pending
    entity_id: binary_sensor.node_proxmox_5_updates_packages

  # Disk health: device_class=problem => ON means problem
  - platform: homeassistant
    id: d1_problem
    entity_id: binary_sensor.disk_proxmox_1_ct1000p3pssd8_health
  - platform: homeassistant
    id: d1b_problem
    entity_id: binary_sensor.disk_proxmox_1_samsung_ssd_990_pro_2tb_health
  - platform: homeassistant
    id: d2_problem
    entity_id: binary_sensor.disk_proxmox_2_sk_hynix_bc501_hfm256gdjtng_8310a_health
  - platform: homeassistant
    id: d3_problem
    entity_id: binary_sensor.disk_proxmox_3_kingston_sfyrs1000g_health
  - platform: homeassistant
    id: d4_problem
    entity_id: binary_sensor.disk_proxmox_4_wdc_wds240g1g0b_00rc30_health
  - platform: homeassistant
    id: d5_problem
    entity_id: binary_sensor.disk_proxmox_5_samsung_ssd_990_evo_2tb_health

sensor:
  - platform: homeassistant
    id: n1_cpu
    entity_id: sensor.node_proxmox_1_cpu_used
  - platform: homeassistant
    id: n2_cpu
    entity_id: sensor.node_proxmox_2_cpu_used
  - platform: homeassistant
    id: n3_cpu
    entity_id: sensor.node_proxmox_3_cpu_used
  - platform: homeassistant
    id: n4_cpu
    entity_id: sensor.node_proxmox_4_cpu_used
  - platform: homeassistant
    id: n5_cpu
    entity_id: sensor.node_proxmox_5_cpu_used

  - platform: homeassistant
    id: n1_ram
    entity_id: sensor.node_proxmox_1_memory_used_percentage
  - platform: homeassistant
    id: n2_ram
    entity_id: sensor.node_proxmox_2_memory_used_percentage
  - platform: homeassistant
    id: n3_ram
    entity_id: sensor.node_proxmox_3_memory_used_percentage
  - platform: homeassistant
    id: n4_ram
    entity_id: sensor.node_proxmox_4_memory_used_percentage
  - platform: homeassistant
    id: n5_ram
    entity_id: sensor.node_proxmox_5_memory_used_percentage

  - platform: homeassistant
    id: n1_disk
    entity_id: sensor.node_proxmox_1_disk_used_percentage
  - platform: homeassistant
    id: n2_disk
    entity_id: sensor.node_proxmox_2_disk_used_percentage
  - platform: homeassistant
    id: n3_disk
    entity_id: sensor.node_proxmox_3_disk_used_percentage
  - platform: homeassistant
    id: n4_disk
    entity_id: sensor.node_proxmox_4_disk_used_percentage
  - platform: homeassistant
    id: n5_disk
    entity_id: sensor.node_proxmox_5_disk_used_percentage

  - platform: homeassistant
    id: n1_vm
    entity_id: sensor.node_proxmox_1_virtual_machines_running
  - platform: homeassistant
    id: n2_vm
    entity_id: sensor.node_proxmox_2_virtual_machines_running
  - platform: homeassistant
    id: n3_vm
    entity_id: sensor.node_proxmox_3_virtual_machines_running
  - platform: homeassistant
    id: n4_vm
    entity_id: sensor.node_proxmox_4_virtual_machines_running
  - platform: homeassistant
    id: n5_vm
    entity_id: sensor.node_proxmox_5_virtual_machines_running

  - platform: homeassistant
    id: n1_ct
    entity_id: sensor.node_proxmox_1_containers_running
  - platform: homeassistant
    id: n2_ct
    entity_id: sensor.node_proxmox_2_containers_running
  - platform: homeassistant
    id: n3_ct
    entity_id: sensor.node_proxmox_3_containers_running
  - platform: homeassistant
    id: n4_ct
    entity_id: sensor.node_proxmox_4_containers_running
  - platform: homeassistant
    id: n5_ct
    entity_id: sensor.node_proxmox_5_containers_running
  - platform: homeassistant
    id: n1_mem_used_gb
    entity_id: sensor.node_proxmox_1_memory_used
  - platform: homeassistant
    id: n2_mem_used_gb
    entity_id: sensor.node_proxmox_2_memory_used
  - platform: homeassistant
    id: n3_mem_used_gb
    entity_id: sensor.node_proxmox_3_memory_used
  - platform: homeassistant
    id: n4_mem_used_gb
    entity_id: sensor.node_proxmox_4_memory_used
  - platform: homeassistant
    id: n5_mem_used_gb
    entity_id: sensor.node_proxmox_5_memory_used
  - platform: homeassistant
    id: n1_mem_free_gb
    entity_id: sensor.node_proxmox_1_memory_free
  - platform: homeassistant
    id: n2_mem_free_gb
    entity_id: sensor.node_proxmox_2_memory_free
  - platform: homeassistant
    id: n3_mem_free_gb
    entity_id: sensor.node_proxmox_3_memory_free
  - platform: homeassistant
    id: n4_mem_free_gb
    entity_id: sensor.node_proxmox_4_memory_free
  - platform: homeassistant
    id: n5_mem_free_gb
    entity_id: sensor.node_proxmox_5_memory_free
  - platform: homeassistant
    id: n1_updates_total
    entity_id: sensor.node_proxmox_1_total_updates
  - platform: homeassistant
    id: n2_updates_total
    entity_id: sensor.node_proxmox_2_total_updates
  - platform: homeassistant
    id: n3_updates_total
    entity_id: sensor.node_proxmox_3_total_updates
  - platform: homeassistant
    id: n4_updates_total
    entity_id: sensor.node_proxmox_4_total_updates
  - platform: homeassistant
    id: n5_updates_total
    entity_id: sensor.node_proxmox_5_total_updates

# --- UI ---
lvgl:
  theme:
    obj:
      bg_color: 0x0B1320
      text_color: 0xE6EDF7
    button:
      bg_color: 0x1A2332
      text_color: 0xE6EDF7
      border_color: 0xE57000
      border_width: 1
      radius: 8
      shadow_width: 0
  pages:
    - id: main_page
      widgets:
        - obj:
            x: 0
            y: 0
            width: 100%
            height: 100%
            bg_color: 0x0B1320
            bg_opa: COVER
            border_width: 0
            radius: 0

        - label:
            id: title
            text: "PROXMOX CLUSTER"
            x: 12
            y: 6
            text_font: f_title
            text_color: 0xE57000

        - image:
            src: proxmox_logo
            x: 366
            y: 8

        - label:
            id: global_status
            text: "STATUS: OK"
            x: 12
            y: 46
            text_font: f_row
            text_color: 0x2ECC71

        - label:
            id: header_row
            text: ""
            x: 14
            y: 80
            text_font: f_row
            text_color: 0x5FA8FF

        - label:
            id: row1
            text: "proxmox-1  --    --    --     -   -"
            x: 12
            y: 104
            text_font: f_row
            text_color: 0xE6EDF7

        - label:
            id: row2
            text: "proxmox-2  --    --    --     -   -"
            x: 12
            y: 134
            text_font: f_row
            text_color: 0xE6EDF7

        - label:
            id: row3
            text: "proxmox-3  --    --    --     -   -"
            x: 12
            y: 164
            text_font: f_row
            text_color: 0xE6EDF7

        - label:
            id: row4
            text: "proxmox-4  --    --    --     -   -"
            x: 12
            y: 194
            text_font: f_row
            text_color: 0xE6EDF7

        - label:
            id: row5
            text: "proxmox-5  --    --    --     -   -"
            x: 12
            y: 224
            text_font: f_row
            text_color: 0xE6EDF7

        - button:
            id: touch_row1
            x: 8
            y: 100
            width: 460
            height: 28
            bg_opa: TRANSP
            border_width: 0
            radius: 0
            on_click:
              - lvgl.page.show: node1_page
        - button:
            id: touch_row2
            x: 8
            y: 130
            width: 460
            height: 28
            bg_opa: TRANSP
            border_width: 0
            radius: 0
            on_click:
              - lvgl.page.show: node2_page
        - button:
            id: touch_row3
            x: 8
            y: 160
            width: 460
            height: 28
            bg_opa: TRANSP
            border_width: 0
            radius: 0
            on_click:
              - lvgl.page.show: node3_page
        - button:
            id: touch_row4
            x: 8
            y: 190
            width: 460
            height: 28
            bg_opa: TRANSP
            border_width: 0
            radius: 0
            on_click:
              - lvgl.page.show: node4_page
        - button:
            id: touch_row5
            x: 8
            y: 220
            width: 460
            height: 28
            bg_opa: TRANSP
            border_width: 0
            radius: 0
            on_click:
              - lvgl.page.show: node5_page

        - label:
            id: legend
            text: "Swipe for node details or tap a row"
            x: 12
            y: 280
            text_font: f_small
            text_color: 0x8AA0B8

    - id: node1_page
      widgets:
        - obj:
            x: 0
            y: 0
            width: 100%
            height: 100%
            bg_color: 0x0B1320
            bg_opa: COVER
            border_width: 0
            radius: 0
        - label:
            text: "NODE DETAIL"
            x: 12
            y: 8
            text_font: f_small
            text_color: 0x5FA8FF
        - label:
            id: n1_title
            text: "proxmox-1"
            x: 12
            y: 34
            text_font: f_title
            text_color: 0xE57000
        - label:
            id: n1_l1
            text: "Status: -"
            x: 12
            y: 88
            text_font: f_row
            text_color: 0xE6EDF7
        - label:
            id: n1_l2
            text: "CPU/RAM/DISK: -"
            x: 12
            y: 116
            text_font: f_row
            text_color: 0xE6EDF7
        - label:
            id: n1_l3
            text: "VM/CT/Updates: -"
            x: 12
            y: 144
            text_font: f_row
            text_color: 0xE6EDF7
        - label:
            id: n1_l4
            text: "Mem used/free: -"
            x: 12
            y: 172
            text_font: f_row
            text_color: 0xE6EDF7
        - label:
            id: n1_l5
            text: "Disk health: -"
            x: 12
            y: 200
            text_font: f_row
            text_color: 0xE6EDF7

    - id: node2_page
      widgets:
        - obj:
            x: 0
            y: 0
            width: 100%
            height: 100%
            bg_color: 0x0B1320
            bg_opa: COVER
            border_width: 0
            radius: 0
        - label:
            text: "NODE DETAIL"
            x: 12
            y: 8
            text_font: f_small
            text_color: 0x5FA8FF
        - label:
            id: n2_title
            text: "proxmox-2"
            x: 12
            y: 34
            text_font: f_title
            text_color: 0xE57000
        - label:
            id: n2_l1
            text: "Status: -"
            x: 12
            y: 88
            text_font: f_row
            text_color: 0xE6EDF7
        - label:
            id: n2_l2
            text: "CPU/RAM/DISK: -"
            x: 12
            y: 116
            text_font: f_row
            text_color: 0xE6EDF7
        - label:
            id: n2_l3
            text: "VM/CT/Updates: -"
            x: 12
            y: 144
            text_font: f_row
            text_color: 0xE6EDF7
        - label:
            id: n2_l4
            text: "Mem used/free: -"
            x: 12
            y: 172
            text_font: f_row
            text_color: 0xE6EDF7
        - label:
            id: n2_l5
            text: "Disk health: -"
            x: 12
            y: 200
            text_font: f_row
            text_color: 0xE6EDF7

    - id: node3_page
      widgets:
        - obj:
            x: 0
            y: 0
            width: 100%
            height: 100%
            bg_color: 0x0B1320
            bg_opa: COVER
            border_width: 0
            radius: 0
        - label:
            text: "NODE DETAIL"
            x: 12
            y: 8
            text_font: f_small
            text_color: 0x5FA8FF
        - label:
            id: n3_title
            text: "proxmox-3"
            x: 12
            y: 34
            text_font: f_title
            text_color: 0xE57000
        - label:
            id: n3_l1
            text: "Status: -"
            x: 12
            y: 88
            text_font: f_row
            text_color: 0xE6EDF7
        - label:
            id: n3_l2
            text: "CPU/RAM/DISK: -"
            x: 12
            y: 116
            text_font: f_row
            text_color: 0xE6EDF7
        - label:
            id: n3_l3
            text: "VM/CT/Updates: -"
            x: 12
            y: 144
            text_font: f_row
            text_color: 0xE6EDF7
        - label:
            id: n3_l4
            text: "Mem used/free: -"
            x: 12
            y: 172
            text_font: f_row
            text_color: 0xE6EDF7
        - label:
            id: n3_l5
            text: "Disk health: -"
            x: 12
            y: 200
            text_font: f_row
            text_color: 0xE6EDF7

    - id: node4_page
      widgets:
        - obj:
            x: 0
            y: 0
            width: 100%
            height: 100%
            bg_color: 0x0B1320
            bg_opa: COVER
            border_width: 0
            radius: 0
        - label:
            text: "NODE DETAIL"
            x: 12
            y: 8
            text_font: f_small
            text_color: 0x5FA8FF
        - label:
            id: n4_title
            text: "proxmox-4"
            x: 12
            y: 34
            text_font: f_title
            text_color: 0xE57000
        - label:
            id: n4_l1
            text: "Status: -"
            x: 12
            y: 88
            text_font: f_row
            text_color: 0xE6EDF7
        - label:
            id: n4_l2
            text: "CPU/RAM/DISK: -"
            x: 12
            y: 116
            text_font: f_row
            text_color: 0xE6EDF7
        - label:
            id: n4_l3
            text: "VM/CT/Updates: -"
            x: 12
            y: 144
            text_font: f_row
            text_color: 0xE6EDF7
        - label:
            id: n4_l4
            text: "Mem used/free: -"
            x: 12
            y: 172
            text_font: f_row
            text_color: 0xE6EDF7
        - label:
            id: n4_l5
            text: "Disk health: -"
            x: 12
            y: 200
            text_font: f_row
            text_color: 0xE6EDF7

    - id: node5_page
      widgets:
        - obj:
            x: 0
            y: 0
            width: 100%
            height: 100%
            bg_color: 0x0B1320
            bg_opa: COVER
            border_width: 0
            radius: 0
        - label:
            text: "NODE DETAIL"
            x: 12
            y: 8
            text_font: f_small
            text_color: 0x5FA8FF
        - label:
            id: n5_title
            text: "proxmox-5"
            x: 12
            y: 34
            text_font: f_title
            text_color: 0xE57000
        - label:
            id: n5_l1
            text: "Status: -"
            x: 12
            y: 88
            text_font: f_row
            text_color: 0xE6EDF7
        - label:
            id: n5_l2
            text: "CPU/RAM/DISK: -"
            x: 12
            y: 116
            text_font: f_row
            text_color: 0xE6EDF7
        - label:
            id: n5_l3
            text: "VM/CT/Updates: -"
            x: 12
            y: 144
            text_font: f_row
            text_color: 0xE6EDF7
        - label:
            id: n5_l4
            text: "Mem used/free: -"
            x: 12
            y: 172
            text_font: f_row
            text_color: 0xE6EDF7
        - label:
            id: n5_l5
            text: "Disk health: -"
            x: 12
            y: 200
            text_font: f_row
            text_color: 0xE6EDF7
# --- Refresh loop ---
interval:
  - interval: 5s
    then:
      - lambda: |-
          auto fmt_pct = [](float v) {
            if (v != v) return std::string("--");
            char b[8];
            snprintf(b, sizeof(b), "%2.0f%%", v);
            return std::string(b);
          };
          auto fmt_i = [](float v) {
            if (v != v) return std::string("-");
            char b[8];
            snprintf(b, sizeof(b), "%d", (int)(v + 0.5f));
            return std::string(b);
          };
          auto fmt_gb = [](float v) {
            if (v != v) return std::string("--");
            char b[12];
            snprintf(b, sizeof(b), "%.1f", v);
            return std::string(b);
          };

          auto row = [&](const char* name, bool up, float cpu, float ram, float disk, float vm, float ct) {
            // Prefix: up/down marker
            const char* mark = up ? " " : "!";
            char line[64];
            // fixed spacing with monospace font for clean column alignment
            snprintf(line, sizeof(line), "%s%-10s %5s %5s %5s %3s %3s",
                     mark, name,
                     fmt_pct(cpu).c_str(),
                     fmt_pct(ram).c_str(),
                     fmt_pct(disk).c_str(),
                     fmt_i(vm).c_str(),
                     fmt_i(ct).c_str());
            return std::string(line);
          };

          char header[64];
          snprintf(header, sizeof(header), "%s%-10s %5s %5s %5s %3s %3s", " ", "NODE", "CPU", "RAM", "DISK", "VM", "CT");
          lv_label_set_text(id(header_row), header);

          lv_label_set_text(id(row1), row("proxmox-1", id(n1_up).state, id(n1_cpu).state, id(n1_ram).state, id(n1_disk).state, id(n1_vm).state, id(n1_ct).state).c_str());
          lv_label_set_text(id(row2), row("proxmox-2", id(n2_up).state, id(n2_cpu).state, id(n2_ram).state, id(n2_disk).state, id(n2_vm).state, id(n2_ct).state).c_str());
          lv_label_set_text(id(row3), row("proxmox-3", id(n3_up).state, id(n3_cpu).state, id(n3_ram).state, id(n3_disk).state, id(n3_vm).state, id(n3_ct).state).c_str());
          lv_label_set_text(id(row4), row("proxmox-4", id(n4_up).state, id(n4_cpu).state, id(n4_ram).state, id(n4_disk).state, id(n4_vm).state, id(n4_ct).state).c_str());
          lv_label_set_text(id(row5), row("proxmox-5", id(n5_up).state, id(n5_cpu).state, id(n5_ram).state, id(n5_disk).state, id(n5_vm).state, id(n5_ct).state).c_str());

          auto set_node_detail = [&](lv_obj_t *l1, lv_obj_t *l2, lv_obj_t *l3, lv_obj_t *l4, lv_obj_t *l5,
                                     bool up, bool updates_pending,
                                     float cpu, float ram, float disk, float vm, float ct,
                                     float mem_used, float mem_free, float updates_total, bool disk_ok) {
            char b1[80], b2[80], b3[80], b4[80], b5[80];
            snprintf(b1, sizeof(b1), "Status: %s | Updates pending: %s", up ? "UP" : "DOWN", updates_pending ? "YES" : "NO");
            snprintf(b2, sizeof(b2), "CPU %s   RAM %s   DISK %s", fmt_pct(cpu).c_str(), fmt_pct(ram).c_str(), fmt_pct(disk).c_str());
            snprintf(b3, sizeof(b3), "VM %s   CT %s   Updates %s", fmt_i(vm).c_str(), fmt_i(ct).c_str(), fmt_i(updates_total).c_str());
            snprintf(b4, sizeof(b4), "Memory used/free: %s GB / %s GB", fmt_gb(mem_used).c_str(), fmt_gb(mem_free).c_str());
            snprintf(b5, sizeof(b5), "Disk health: %s", disk_ok ? "OK" : "PROBLEM");
            lv_label_set_text(l1, b1);
            lv_label_set_text(l2, b2);
            lv_label_set_text(l3, b3);
            lv_label_set_text(l4, b4);
            lv_label_set_text(l5, b5);
            lv_obj_set_style_text_color(l5, lv_color_hex(disk_ok ? 0x2ECC71 : 0xE74C3C), LV_PART_MAIN);
          };

          set_node_detail(id(n1_l1), id(n1_l2), id(n1_l3), id(n1_l4), id(n1_l5),
                          id(n1_up).state, id(n1_updates_pending).state,
                          id(n1_cpu).state, id(n1_ram).state, id(n1_disk).state, id(n1_vm).state, id(n1_ct).state,
                          id(n1_mem_used_gb).state, id(n1_mem_free_gb).state, id(n1_updates_total).state,
                          !(id(d1_problem).state || id(d1b_problem).state));
          set_node_detail(id(n2_l1), id(n2_l2), id(n2_l3), id(n2_l4), id(n2_l5),
                          id(n2_up).state, id(n2_updates_pending).state,
                          id(n2_cpu).state, id(n2_ram).state, id(n2_disk).state, id(n2_vm).state, id(n2_ct).state,
                          id(n2_mem_used_gb).state, id(n2_mem_free_gb).state, id(n2_updates_total).state,
                          !id(d2_problem).state);
          set_node_detail(id(n3_l1), id(n3_l2), id(n3_l3), id(n3_l4), id(n3_l5),
                          id(n3_up).state, id(n3_updates_pending).state,
                          id(n3_cpu).state, id(n3_ram).state, id(n3_disk).state, id(n3_vm).state, id(n3_ct).state,
                          id(n3_mem_used_gb).state, id(n3_mem_free_gb).state, id(n3_updates_total).state,
                          !id(d3_problem).state);
          set_node_detail(id(n4_l1), id(n4_l2), id(n4_l3), id(n4_l4), id(n4_l5),
                          id(n4_up).state, id(n4_updates_pending).state,
                          id(n4_cpu).state, id(n4_ram).state, id(n4_disk).state, id(n4_vm).state, id(n4_ct).state,
                          id(n4_mem_used_gb).state, id(n4_mem_free_gb).state, id(n4_updates_total).state,
                          !id(d4_problem).state);
          set_node_detail(id(n5_l1), id(n5_l2), id(n5_l3), id(n5_l4), id(n5_l5),
                          id(n5_up).state, id(n5_updates_pending).state,
                          id(n5_cpu).state, id(n5_ram).state, id(n5_disk).state, id(n5_vm).state, id(n5_ct).state,
                          id(n5_mem_used_gb).state, id(n5_mem_free_gb).state, id(n5_updates_total).state,
                          !id(d5_problem).state);

          // Global status computation
          bool any_node_down = !(id(n1_up).state && id(n2_up).state && id(n3_up).state && id(n4_up).state && id(n5_up).state);
          bool any_updates = (id(n1_updates_pending).state || id(n2_updates_pending).state || id(n3_updates_pending).state || id(n4_updates_pending).state || id(n5_updates_pending).state);

          // These *_health binary sensors are device_class=problem => ON means problem.
          // So disks are healthy only when all problem sensors are OFF.
          bool all_disks_healthy =
            !(id(d1_problem).state || id(d1b_problem).state || id(d2_problem).state || id(d3_problem).state || id(d4_problem).state || id(d5_problem).state);
          bool any_disk_problem = !all_disks_healthy;

          std::string status = "STATUS: OK";
          uint32_t status_color = 0x2ECC71;
          if (any_node_down) {
            status = "STATUS: NODE DOWN";
            status_color = 0xE74C3C;
          } else if (any_disk_problem) {
            status = "STATUS: DISK PROBLEM";
            status_color = 0xE74C3C;
          } else if (any_updates) {
            status = "STATUS: UPDATES PENDING";
            status_color = 0xF39C12;
          }

          lv_label_set_text(id(global_status), status.c_str());
          lv_obj_set_style_text_color(id(global_status), lv_color_hex(status_color), LV_PART_MAIN);
          lv_label_set_text(id(legend), any_disk_problem ? "Disk issue detected" : "OK=all nodes up, no disk problems");
